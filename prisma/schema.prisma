generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

enum Role {
  TEACHER
  STUDENT
}

enum AssessmentItemType {
  MCQ
  CONTEXT
}

enum IssueType {
  CLASS_JOIN_REQUEST
  QUESTION_ISSUE
  FEEDBACK_ISSUE
}

enum IssueStatus {
  UNREAD
  OPEN
  RESOLVED
  REJECTED
}

model User {
  id                 String       @id
  name               String
  nickname           String       @unique
  email              String       @unique
  createdAt          DateTime     @default(now()) @map(name: "created_at")
  updatedAt          DateTime     @updatedAt @map(name: "updated_at")
  role               Role
  taughtClasses      Class[]      @relation("TaughtBy")
  memberOfClasses    Class[]      @relation("ClassMembers")
  createdAssessments Assessment[] @relation("AssessmentCreator")
  submissions        Submission[] @relation("UserSubmissions")
  responses          Response[]   @relation("UserResponses")
  raisedIssues       Issue[]      @relation("UserIssues")
  messages           Message[]    @relation("UserMessages")
  lastUpdatedIssues  Issue[]      @relation("LastUpdatedBy")
}

model Class {
  id          String       @id
  title       String
  description String
  createdAt   DateTime     @default(now()) @map(name: "created_at")
  updatedAt   DateTime     @updatedAt @map(name: "updated_at")
  taughtBy    User[]       @relation("TaughtBy")
  members     User[]       @relation("ClassMembers")
  assessments Assessment[] @relation("ClassAssessments")
  issues      Issue[]      @relation("ClassIssues")
}

model Assessment {
  id              String           @id @default(uuid())
  title           String
  objectives      String
  createdAt       DateTime         @default(now()) @map(name: "created_at")
  updatedAt       DateTime         @updatedAt @map(name: "updated_at")
  createdBy       User             @relation("AssessmentCreator", fields: [createdById], references: [id])
  createdById     String
  class           Class            @relation("ClassAssessments", fields: [classId], references: [id], onDelete: Cascade)
  classId         String
  assessmentItems AssessmentItem[]
  submissions     Submission[]
  teacherFeedback TeacherFeedback?
}

model TeacherFeedback {
  id               String     @id @default(uuid())
  content          String
  assessment       Assessment @relation(fields: [assessmentId], references: [id])
  assessmentId     String     @unique
  submissionCount  Int
  lastSubmission   Submission @relation(fields: [lastSubmissionId], references: [id])
  lastSubmissionId String     @unique
  createdAt        DateTime   @default(now()) @map(name: "created_at")
}

model AssessmentItem {
  id             String             @id @default(uuid())
  index          Int
  content        String
  type           AssessmentItemType
  assessment     Assessment         @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  assessmentId   String
  responses      Response[]
  answers        Answer[]           @relation("AssessmentItemToAnswer")
  issues         Issue[]
}

model Answer {
  id               String         @id @default(uuid())
  content          String
  isCorrect        Boolean
  assessmentItem   AssessmentItem @relation("AssessmentItemToAnswer", fields: [assessmentItemId], references: [id], onDelete: Cascade)
  assessmentItemId String
  responses        Response[] 
}

model Submission {
  id           String     @id @default(uuid())
  createdAt    DateTime   @default(now()) @map(name: "created_at")
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  assessmentId String
  user         User       @relation("UserSubmissions", fields: [userId], references: [id])
  userId       String
  responses    Response[]
  feedback     String?
  score        Float?
  teacherFeedback TeacherFeedback?
  issues           Issue[]
}

model Response {
  id               String         @id @default(uuid())
  createdAt        DateTime       @default(now()) @map(name: "created_at")
  submission       Submission     @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  submissionId     String
  assessmentItem   AssessmentItem @relation(fields: [assessmentItemId], references: [id])
  assessmentItemId String
  user             User           @relation("UserResponses", fields: [userId], references: [id])
  userId           String
  givenAnswer      Answer         @relation(fields: [givenAnswerId], references: [id])
  givenAnswerId    String
  isCorrect        Boolean
}

model Issue {
  id               String      @id @default(uuid())
  type             IssueType
  status           IssueStatus @default(UNREAD)
  createdAt        DateTime    @default(now()) @map(name: "created_at")
  updatedAt        DateTime    @updatedAt @map(name: "updated_at")
  raisedBy         User        @relation("UserIssues", fields: [raisedById], references: [id])
  raisedById       String
  lastUpdatedBy    User        @relation("LastUpdatedBy", fields: [lastUpdatedById], references: [id])
  lastUpdatedById  String
  relevantClass    Class       @relation("ClassIssues", fields: [relevantClassId], references: [id], onDelete: Cascade)
  relevantClassId  String
  messages         Message[]   @relation("IssueMessages")
  
  // Fields for question issues
  question         String?
  givenAnswer      String?
  correctAnswer    String?
  assessmentItem   AssessmentItem?   @relation(fields: [assessmentItemId], references: [id], onDelete: SetNull)
  assessmentItemId String?
  
  // Fields for feedback issues
  feedback         String?
  submission       Submission? @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  submissionId     String?
}

model Message {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now()) @map(name: "created_at")
  sender    User     @relation("UserMessages", fields: [senderId], references: [id])
  senderId  String
  issue     Issue    @relation("IssueMessages", fields: [issueId], references: [id], onDelete: Cascade)
  issueId   String
}